{% extends 'app/base.html' %}
{% load static %}
{% block title %}–ö–∞—Ä—Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤{% endblock %}

{% block content %}
<div class="btn" onclick="sendLocation()">üìç –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å –º—ñ—Å—Ü–µ–º</div>
<div id="map" style="height: 80vh;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([50.45, 30.52], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const markers = {};

function loadUsers() {
    fetch("/api/map/")
        .then(res => res.json())
        .then(users => {
            users.forEach(user => {
                if (markers[user.id]) {
                    markers[user.id].setLatLng([user.lat, user.lng]);
                } else {
                    const marker = L.marker([user.lat, user.lng]).addTo(map);
                    marker.bindPopup(`
                        <b>${user.username}</b><br>
                        <button onclick="openChat(${user.id})">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
                    `);
                    markers[user.id] = marker;
                }
            });
        });
}

setInterval(loadUsers, 5000);
loadUsers();

function sendLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        fetch("/api/update-location/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            })
        })
    })
}

function openChat(userId) {
    window.location.href = `/chat/${userId}/`
}
</script>

<style>
.btn {
    position: fixed;
    top: 100px;
    left: 20px;
    z-index: 999;
    padding: 12px 20px;
    background: black;
    color: white;
    border-radius: 10px;
    cursor: pointer;
}
</style>
{% endblock %}
